<?xml version="1.0" encoding="utf-8" ?>
<Application autoNameMapping="1">
	
	<Window id="wndApp" caption="New York Times Crossword Scraper" width="1024" height="768">
		<BiCommand id="cmdPrint" shortcut="CTRL+P"/>
		<BiCommand id="cmdLoad" shortcut="ENTER"/>

		<BiVBox left="7" top="7" right="7" bottom="7">
			<BiLabel id="lblAuthor"/>
			<BiIframe id="frameOut" BiBox.flex="9"/>
			<BiIframe id="frameCanvas" BiBox.flex="1"/>
		</BiVBox>

		<BiWindow id="wndOptions" caption="Options" left="500" resizable="false" showClose="false" showMaximize="false" showMinimize="false" top="50" height="250" width="350">
			<BiVBox left="7" top="7" right="7" bottom="7">
				<BiCalendar id="cal" BiBox.flex="1"/>
				<BiHBox marginTop="7" align="center">
					<BiCheckBox id="btnShowAnswers" marginBottom="3" marginRight="7" text="Show Answers"/>
					<BiCheckBox id="btnDiagramless" BiBox.flex="1" marginBottom="3" text="Diagramless"/>
					<BiButton text="Print..." command="cmdPrint" toolTipText="Print the puzzle. (CTRL+P)"/>
					<!-- BiButton text="Load" command="cmdLoad" toolTipText="Load puzzle specified at end of URL. (ENTER)"/-->
				</BiHBox>
			</BiVBox>
		</BiWindow>
	</Window>

	<Resources>
		<Script src="../../jquery/js/jquery.js" type="text/javascript"/>
		<Script src="../../3rdparty_resources/html2canvas-0.4.1/html2canvas.js" type="text/javascript"/>

		<Script src="../shared_resources/source/BiProtoFixes.js" type="text/javascript"/>
		<Script src="../shared_resources/source/ie_standards_mode_patches.js" type="text/javascript"/>
		<Script>
			<![CDATA[
			$(function()
			{
			});

			nytcword.main = function()
			{
				new nytcword();
			};
			
			function nytcword()
			{
				if (_biInPrototype) return;
				BiObject.call(this);
				frameOut.setBorder(null);
				
				cal.addEventListener("change", this._onLoadPuzzle, this);
				cal.setSelectedDate(new Date());
				
				btnShowAnswers.addEventListener("change", this._onLoadPuzzle, this);
				btnDiagramless.addEventListener("change", this._onLoadPuzzle, this);

				cmdPrint.addEventListener("execute", this._onPrintPuzzle, this);
				cmdLoad.execute();

				wndOptions.bringToFront();
			}
			var protoPuz = _biExtend(nytcword, BiObject, "nytcword")
			var basePuz = BiObject.prototype;

			protoPuz._onLoadPuzzle = function _onLoadPuzzle(e)
			{
				var date = cal.getSelectedDate();
				
				var strParm = BiStringBundle.formatString("http://www.xwordinfo.com/Crossword?date=%1/%2/%3", date.getMonth() + 1, date.getDate(), date.getFullYear());
				var uri = new BiUri(application.getPath(), "../tools/nytcword/proxy.jsp?" + strParm);
				var strPuzzle = BiTextLoader.load(uri);
				strPuzzle = strPuzzle.replace(/<script(\s|\S)*?<\/script>/g, "");
				frameOut.setVisible(false);
				frameOut.addEventListener("load", this._onPuzzleLoaded, this);
				var doc = frameOut.getContentDocument();
				doc.open();
				doc.write(strPuzzle);
				doc.close();
			}
			
			protoPuz._onPuzzleLoaded = function _onPuzzleLoaded(e)
			{
				if(!this._bInLoad)
				{
					this._bInLoad = true;
					try
					{
						var doc = e.getTarget().getContentDocument();
						var puzTab = doc.getElementById("CPHContent_PuzTable");
						var strPuzTab = puzTab.outerHTML;
						var puzClues = doc.getElementById("CPHContent_AnsTable");
						var strPuzClues = puzClues.outerHTML.replace(/:/g, "");
						var strStyle =
						"\
						   <style type='text/css' media='all'>\
								.PuzTable {margin-bottom:10px;border-collapse:collapse;}\
								.PuzTable td {vertical-align:top;height:24px;width:24px;border:1px solid black;padding:0px;}\
								.vblack {background-color:#000000;visibility:%2;}\
								.num{height:6pt;font-family:arial;font-size:6pt;visibility:%2}\
								.letter{height:100%;width:100%;font-family:helvetica;font-size:8pt;text-align:center;display:%1;}\
								.subst{font-family:verdana;font-size:8pt;text-align:center;display:%1;}\
								.subst2{font-family:verdana;font-size:8pt;text-align:center;display:%1;}\
								.clue{font-family:arial;font-size:7pt;vertical-align:top}\
								.clhead{font-family:arial;font-size:12pt;font-weight:bold;}\
								a{visibility:hidden;}\
							</style>\
						";
						var bDiagramless = !btnDiagramless.getChecked();
						var bShowAnswers = btnShowAnswers.getChecked();
						strStyle = BiStringBundle.formatString(strStyle, bShowAnswers ? "auto" : "none",
							bDiagramless ? "visible" : "hidden");

						doc.open()
						doc.write(BiStringBundle.formatString("<html><head>%1</head><body>\n<div class='clue' style='font-size:9pt;'>(c) New York Times Crossword, %2</div>\n%3\n%4\n</body>",
							strStyle, cal.getSelectedDate().toDateString(), strPuzTab, strPuzClues));
						doc.close();
						frameOut.setVisible(true);


						var options = 
						{
							width: 72 * 8.5,
							height: 72 * 11,
							onrendered: function(canvas)
							{
								$("#frameCanvas").contents().find("body").empty().append(canvas);
							}
						};


						var $doc = $("#frameOut").contents();
						var $elem = $doc.find("body").css({"margin":"0px", "background-color":"white"});
						html2canvas($elem, options);

						this._bInLoad = false;
					}
					catch(ex)
					{
						frameOut.setVisible(true);
						this._bInLoad = false;
					}
				}
			}

			protoPuz._onPrintPuzzle = function _onPrintPuzzle(e)
			{
				frameOut.getContentDocument().execCommand("print", "true");
				//frameCanvas.getContentDocument().execCommand("print", "true");
			}
		]]>
		</Script>
	</Resources>
</Application>
